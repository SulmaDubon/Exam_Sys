{% extends 'base.html' %}

{% block title %}Formulario de Pregunta{% endblock %}

{% block content %}
<div class="admin-container">
    <h1>Formulario de Pregunta</h1>
    <form method="post">
        {% csrf_token %}
        
        <!-- Tipo de Examen -->
        <div class="form-group">
            <label for="id_tipo_examen">Tipo de Examen:</label>
            {{ form.tipo_examen }}
        </div>

        <!-- Módulo, se actualizará según el tipo de examen seleccionado -->
        <div class="form-group">
            <label for="id_modulo">Módulo asociado:</label>
            {{ form.modulo }}
        </div>

        <!-- Checkbox para decidir si usar enunciado -->
        <div class="form-group">
            <label for="usar_enunciado">¿Usar enunciado?</label>
            <input type="checkbox" id="usar_enunciado">
        </div>

        <!-- Campo para el enunciado (se muestra solo si el checkbox está marcado) -->
        <div id="enunciado-container" style="display: none;">
            <div class="form-group">
                <label for="id_enunciado">Enunciado:</label>
                {{ form.enunciado }}
            </div>

            <h3>Preguntas derivadas</h3>
            {{ pregunta_formset.management_form }}
            {% for pregunta_form in pregunta_formset %}
                <div class="form-group pregunta-derivada">
                    {{ pregunta_form.as_p }} <!-- Formulario para cada pregunta derivada -->
                    <h4>Respuestas</h4>
                    {{ respuesta_formset_list.forloop.counter0.management_form }}
                    {% for respuesta_form in respuesta_formset_list.forloop.counter0 %}
                        <div class="respuesta-group">
                            {{ respuesta_form.as_p }} <!-- Respuestas para la pregunta derivada -->
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
        </div>

        <!-- Si no se selecciona el enunciado, mostramos el texto de la pregunta y sus respuestas -->
        <div id="pregunta-container">
            <div class="form-group">
                <label for="id_texto">Texto de la pregunta:</label>
                {{ form.texto }}
            </div>

            <h4>Respuestas</h4>
            {{ formset.management_form }}
            {% for respuesta_form in formset %}
                <div class="respuesta-group">
                    {{ respuesta_form.as_p }}
                </div>
            {% endfor %}
        </div>

        <!-- Botones de guardar y cancelar -->
        <div class="button-container">
            <button type="submit" class="btn btn-primary">Guardar</button>
            <a href="{% url 'admin_panel:lista_preguntas' %}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const tipoExamenSelect = document.getElementById('id_tipo_examen');
        const moduloSelect = document.getElementById('id_modulo');
        const usarEnunciadoCheckbox = document.getElementById('usar_enunciado');
        const enunciadoContainer = document.getElementById('enunciado-container');
        const preguntaContainer = document.getElementById('pregunta-container');

        // Función para actualizar el select de módulos según el tipo de examen seleccionado
        tipoExamenSelect.addEventListener('change', function () {
            const tipoExamenId = this.value;
            if (tipoExamenId) {
                fetch(`/get-modulos/${tipoExamenId}/`)
                    .then(response => response.json())
                    .then(data => {
                        // Limpiar el select de módulos
                        moduloSelect.innerHTML = '';

                        // Agregar las nuevas opciones de módulos
                        data.modulos.forEach(modulo => {
                            const option = document.createElement('option');
                            option.value = modulo.id;
                            option.textContent = modulo.nombre;
                            moduloSelect.appendChild(option);
                        });
                    });
            } else {
                // Limpiar el select si no se ha seleccionado ningún tipo de examen
                moduloSelect.innerHTML = '';
            }
        });

        // Mostrar u ocultar el enunciado y las preguntas derivadas
        usarEnunciadoCheckbox.addEventListener('change', function () {
            if (this.checked) {
                enunciadoContainer.style.display = 'block';
                preguntaContainer.style.display = 'none';
            } else {
                enunciadoContainer.style.display = 'none';
                preguntaContainer.style.display = 'block';
            }
        });
    });
</script>
{% endblock %}

{% block head %}
<style>
    .admin-container {
        padding: 20px;
        max-width: 800px;
        margin: auto;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    h1 {
        color: #333;
        text-align: center;
        margin-bottom: 20px;
    }
    .form-group {
        margin-bottom: 15px;
    }
    label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    input[type="text"], textarea, select {
        padding: 10px;
        width: calc(100% - 22px);
        border: 1px solid #ccc;
        border-radius: 5px;
        margin-bottom: 10px;
    }
    .respuesta-group {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    .respuesta-group input[type="radio"] {
        margin-right: 10px;
    }
    .respuesta-group label {
        flex-grow: 1;
    }
    .button-container {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
    }
    .btn-primary {
        background-color: #007bff;
        border: none;
        color: #fff;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
    }
    .btn-secondary {
        background-color: #6c757d;
        border: none;
        color: #fff;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
    }
    .error {
        color: red;
        font-size: 0.875em;
    }
</style>
{% endblock %}
